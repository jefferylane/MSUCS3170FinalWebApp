<div class="container">
  <div class="row">
    <!-- Profile Area -->
    <div class="col-md-4">
      <% if @user.avatar.attached? %>
        <div class="d-flex justify-content-center align-items-center mb-3">
          <%= image_tag @user.avatar, class: "card-img-top avatar-img"%>
        </div>
      <% end %>

      <h5 class="text-center"><%= @user.username %></h5>
      <p><%= @user.bio %></p>

      <% if user_signed_in? && current_user == @user %>
        <div class="text-center">
          <%= link_to 'Edit Profile', edit_profile_path, class: 'btn btn-primary' %>
        </div>
      <% end %>
    </div>

    <!-- 3D Files Area -->
    <div class="col-md-8">
      <h2>3D Files</h2>
      <div class="row">
        <% @user.three_d_files.each do |file| %>
          <div class="col-md-6 mb-4">
            <div class="card">
              <div 
                data-controller="three-d-preview"
                data-three-d-preview-url-value="<%= rails_blob_path(file.file) %>"
                data-three-d-preview-container-id-value="preview-<%= file.id %>"
                class="preview-container" 
                id="preview-<%= file.id %>" 
                style="height: 200px;">
              </div>
              <div class="card-body">
                <h5 class="card-title"><%= file.name %></h5>
                <p class="card-text">
                  Uploaded: <%= file.created_at.strftime("%B %d, %Y") %>
                </p>
                <div class="btn-group">
                  <%= link_to 'View', three_d_file_path(file), class: 'btn btn-primary' %>
                  <% if user_signed_in? && current_user == @user %>
                    <%= link_to 'Edit', edit_three_d_file_path(file), class: 'btn btn-secondary' %>
                    <%= button_to 'Delete', three_d_file_path(file), 
                        method: :delete, 
                        class: 'btn btn-danger',
                        data: { confirm: 'Are you sure?' } %>
                  <% end %>
                </div>
              </div>
            </div>
          </div>
        <% end %>
      </div>
    </div>
  </div>
</div>

<div class="col-12">
  <% if @three_d_file %>
    <h1 class="mb-4"><%= @three_d_file.name %></h1>
    <p>By <%= link_to @three_d_file.user.username, users_user_path(@three_d_file.user), aria: { label: 'View User Profile' } %></p>
    <img src="<%= @user.avatar.url %>" alt="Avatar of <%= @user.username %>" aria-label="User Avatar">
  <% else %>j
  <% end %>
</div>

<div class="row">
  <div class="col-md-4">
    <% if @three_d_file %>
      <div class="card mb-4" aria-label="3D File Preview Card">
        <div class="card-body">
          <div 
            data-controller="three-d-preview"
            data-three-d-preview-url-value="<%= rails_blob_path(@three_d_file.file) %>"
            data-three-d-preview-container-id-value="preview-<%= @three_d_file.id %>"
            class="preview-container mb-4" 
            id="preview-<%= @three_d_file.id %>" 
            style="width: 100%; height: 400px;"
            aria-label="3D Preview Container">
          </div>
          <%= link_to 'Download', rails_blob_path(@three_d_file.file, disposition: "attachment"), class: "btn btn-primary", aria: { label: 'Download 3D File' } %>
        </div>
      </div>
    <% else %>
    <% end %>
  </div>

  <!-- Right column for details -->
  <div class="col-md-8">
    <% if @three_d_file %>
      <div class="card mb-4" aria-label="3D File Details Card">
        <div class="card-body">
          <p class="three-d-file-description" aria-label="3D File Description"><%= @three_d_file.description %></p>
          <p class="three-d-file-details" aria-label="3D File Size">File Size: <%= number_to_human_size(@file_size) %></p>
          <p class="three-d-file-details" aria-label="3D File Type">File Type: <%= human_readable_file_type(@file_type) %></p>
        </div>
      </div>
    <% else %>
    <% end %>
  </div>
</div>

<!-- Load Three.js and required modules -->
<%= javascript_include_tag "https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js" %>
<%= javascript_include_tag "https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js" %>
<%= javascript_include_tag "https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/loaders/GLTFLoader.js" %>